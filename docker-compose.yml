# =============================================================================
# RedAmon - GVM/OpenVAS Minimal Setup (API Only, No Web GUI)
# =============================================================================
# This setup provides the minimal services needed for Python API-based
# vulnerability scanning. No web interface (GSA) is included.
#
# Usage:
#   docker compose up -d
#   docker compose logs -f gvmd  # Wait for "Starting GVMd"
#   docker compose exec gvmd gvmd --create-user=admin --password=admin
#
# First startup takes 10-15 minutes for NVT/SCAP data synchronization.
# =============================================================================

services:
  # ===========================================================================
  # DATA CONTAINERS (Init only - exit after populating volumes)
  # These containers download and extract vulnerability feed data
  # ===========================================================================
  
  vulnerability-tests:
    image: registry.community.greenbone.net/community/vulnerability-tests
    container_name: redamon-gvm-vt
    environment:
      FEED_RELEASE: "24.10"
    volumes:
      - vt_data:/mnt

  notus-data:
    image: registry.community.greenbone.net/community/notus-data
    container_name: redamon-gvm-notus-data
    volumes:
      - notus_data:/mnt

  scap-data:
    image: registry.community.greenbone.net/community/scap-data
    container_name: redamon-gvm-scap-data
    volumes:
      - scap_data:/mnt

  cert-bund-data:
    image: registry.community.greenbone.net/community/cert-bund-data
    container_name: redamon-gvm-cert-data
    volumes:
      - cert_data:/mnt

  dfn-cert-data:
    image: registry.community.greenbone.net/community/dfn-cert-data
    container_name: redamon-gvm-dfn-cert
    volumes:
      - cert_data:/mnt
    depends_on:
      - cert-bund-data

  data-objects:
    image: registry.community.greenbone.net/community/data-objects
    container_name: redamon-gvm-data-objects
    environment:
      FEED_RELEASE: "24.10"
    volumes:
      - data_objects:/mnt

  report-formats:
    image: registry.community.greenbone.net/community/report-formats
    container_name: redamon-gvm-report-formats
    environment:
      FEED_RELEASE: "24.10"
    volumes:
      - data_objects:/mnt
    depends_on:
      - data-objects

  gpg-data:
    image: registry.community.greenbone.net/community/gpg-data
    container_name: redamon-gvm-gpg-data
    volumes:
      - gpg_data:/mnt

  # ===========================================================================
  # RUNTIME SERVICES (Always running)
  # ===========================================================================

  redis-server:
    image: registry.community.greenbone.net/community/redis-server
    container_name: redamon-gvm-redis
    restart: on-failure
    volumes:
      - redis_socket:/run/redis/

  pg-gvm:
    image: registry.community.greenbone.net/community/pg-gvm:stable
    container_name: redamon-gvm-postgres
    restart: on-failure
    volumes:
      - psql_data:/var/lib/postgresql
      - psql_socket:/var/run/postgresql

  gvmd:
    image: registry.community.greenbone.net/community/gvmd:stable
    container_name: redamon-gvm-gvmd
    restart: on-failure
    volumes:
      - gvmd_data:/var/lib/gvm
      - scap_data:/var/lib/gvm/scap-data/
      - cert_data:/var/lib/gvm/cert-data
      - data_objects:/var/lib/gvm/data-objects/gvmd
      - vt_data:/var/lib/openvas/plugins
      - psql_data:/var/lib/postgresql
      - gvmd_socket:/run/gvmd
      - ospd_socket:/run/ospd
      - psql_socket:/var/run/postgresql
    depends_on:
      pg-gvm:
        condition: service_started
      scap-data:
        condition: service_completed_successfully
      cert-bund-data:
        condition: service_completed_successfully
      dfn-cert-data:
        condition: service_completed_successfully
      data-objects:
        condition: service_completed_successfully
      report-formats:
        condition: service_completed_successfully

  # OSPD-OpenVAS scanner (creates the socket gvmd expects)
  # NOTE: The pcap errors for callback-based detection (Log4Shell, etc.) are
  # expected in Docker bridge networking. Most vulnerability detection still
  # works via version checks and response analysis. Using network_mode: host
  # would break socket communication with other containers.
  ospd-openvas:
    image: registry.community.greenbone.net/community/ospd-openvas:stable
    container_name: redamon-gvm-ospd
    restart: on-failure
    cap_add:
      - NET_ADMIN
      - NET_RAW
    security_opt:
      - seccomp=unconfined
      - apparmor=unconfined
    volumes:
      - gpg_data:/etc/openvas/gnupg
      - vt_data:/var/lib/openvas/plugins
      - notus_data:/var/lib/notus
      - ospd_socket:/run/ospd
      - redis_socket:/run/redis/
    depends_on:
      redis-server:
        condition: service_started
      gpg-data:
        condition: service_completed_successfully
      vulnerability-tests:
        condition: service_completed_successfully

  # ===========================================================================
  # PYTHON SCANNER (RedAmon integration)
  # Mount the gvmd socket and recon output for vulnerability scanning
  # ===========================================================================

  python-scanner:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: redamon-vuln-scanner
    volumes:
      - gvmd_socket:/run/gvmd:ro
      - ./recon/output:/app/recon/output:ro
      - ./gvm_scan/output:/app/gvm_scan/output
    depends_on:
      - gvmd
      - ospd-openvas
    profiles:
      - scanner  # Only start when explicitly requested

volumes:
  vt_data:
    name: redamon_vt_data
  notus_data:
    name: redamon_notus_data
  scap_data:
    name: redamon_scap_data
  cert_data:
    name: redamon_cert_data
  data_objects:
    name: redamon_data_objects
  gpg_data:
    name: redamon_gpg_data
  redis_socket:
    name: redamon_redis_socket
  psql_data:
    name: redamon_psql_data
  psql_socket:
    name: redamon_psql_socket
  gvmd_data:
    name: redamon_gvmd_data
  gvmd_socket:
    name: redamon_gvmd_socket
  ospd_socket:
    name: redamon_ospd_socket
